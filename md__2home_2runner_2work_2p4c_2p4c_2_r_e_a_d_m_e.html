<!-- HTML header for doxygen 1.11.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4C: P4C</title>
<link rel="icon" href="p4-fav.svg" type="image/svg+xml"  />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2p4c_2p4c_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">P4C</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md11"></a><a href="https://github.com/p4lang/p4c/actions/workflows/ci-test-debian.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-test-debian.yml/badge.svg" alt="Main Build" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-test-fedora.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-test-fedora.yml/badge.svg" alt="Main Build" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-test-mac.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-test-mac.yml/badge.svg" alt="Main Build" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-bazel.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-bazel.yml/badge.svg" alt="Bazel Build" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-validation-nightly.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-validation-nightly.yml/badge.svg" alt="Validation" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-container-image.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-container-image.yml/badge.svg" alt="Docker Container" style="pointer-events: none;" class="inline"/></a></p>
<ul>
<li>Getting started<ul>
<li>Installing packaged versions of P4C</li>
<li>Installing P4C from source</li>
</ul>
</li>
<li>Dependencies<ul>
<li>Ubuntu dependencies</li>
<li>Fedora dependencies</li>
<li>macOS dependencies</li>
<li>Garbage collector</li>
<li>Crash dumps</li>
</ul>
</li>
<li>Development tools<ul>
<li>Git setup</li>
</ul>
</li>
<li>Docker</li>
<li>Bazel</li>
<li>Build system<ul>
<li>Defining new CMake targets</li>
</ul>
</li>
<li>Known issues<ul>
<li>Frontend</li>
<li>Backends</li>
</ul>
</li>
<li>How to Contribute</li>
<li>P4 Compiler Onboarding</li>
<li>Contact</li>
</ul>
<p>P4C is a reference compiler for the <a class="el" href="namespace_p4.html">P4</a> programming language. It supports both P4-14 and P4-16; you can find more information about <a class="el" href="namespace_p4.html">P4</a> <a href="http://p4.org">here</a> and the specifications for both versions of the language <a href="https://p4.org/specs">here</a>. One fact attesting to the level of quality and completeness of P4C's code is that its front-end code, mid-end code, and P4C-graphs back end are used as the basis for at least one commercially supported <a class="el" href="namespace_p4.html">P4</a> compiler.</p>
<p>P4C is modular; it provides a standard frontend and midend which can be combined with a target-specific backend to create a complete <a class="el" href="namespace_p4.html">P4</a> compiler. The goal is to make adding new backends easy.</p>
<p>The code contains seven sample backends:</p><ul>
<li>p4c-bm2-ss: can be used to target the <a class="el" href="namespace_p4.html">P4</a> <code>simple_switch</code> written using the <a href="https://github.com/p4lang/behavioral-model">BMv2 behavioral model</a>,</li>
<li>p4c-dpdk: can be used to target the <a href="https://doc.dpdk.org/guides/rel_notes/release_20_11.html">DPDK software switch (SWX) pipeline</a>,</li>
<li>p4c-ebpf: can be used to generate C code which can be compiled to <a href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter">eBPF</a> and then loaded in the Linux kernel. The eBPF backend currently implements three architecture models: <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2ebpf_2_r_e_a_d_m_e.html">ebpf_model.p4 for packet filtering, xdp_model.p4 for XDP</a> and <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2ebpf_2psa_2_r_e_a_d_m_e.html">the fully-featured PSA (Portable Switch Architecture) model</a>.</li>
<li>p4test: a source-to-source <a class="el" href="namespace_p4.html">P4</a> translator which can be used for testing, learning compiler internals and debugging,</li>
<li>p4c-graphs: can be used to generate visual representations of a <a class="el" href="namespace_p4.html">P4</a> program; for now it only supports generating graphs of top-level control flows, and</li>
<li>p4c-ubpf: can be used to generate eBPF code that runs in user-space.</li>
<li>p4tools: a platform for <a class="el" href="namespace_p4.html">P4</a> test utilities, including a test-case generator for <a class="el" href="namespace_p4.html">P4</a> programs. Sample command lines:</li>
</ul>
<p>Compile P4_16 or P4_14 source code. If your program successfully compiles, the command will create files with the same base name as the <a class="el" href="namespace_p4.html">P4</a> program you supplied, and the following suffixes instead of the <code>.p4</code>:</p>
<ul>
<li>a file with suffix <code>.p4i</code>, which is the output from running the preprocessor on your <a class="el" href="namespace_p4.html">P4</a> program.</li>
<li>a file with suffix <code>.json</code> that is the JSON file format expected by BMv2 behavioral model <code>simple_switch</code>.</li>
</ul>
<div class="fragment"><div class="line">p4c --target bmv2 --arch v1model my-p4-16-prog.p4</div>
<div class="line">p4c --target bmv2 --arch v1model --std p4-14 my-p4-14-prog.p4</div>
</div><!-- fragment --><p>By adding the option <code>--p4runtime-files &lt;filename&gt;.txt</code> as shown in the example commands below, P4C will also create a file <code>&lt;filename&gt;.txt</code>. This is a text format "P4Info" file, containing a description of the tables and other objects in your <a class="el" href="namespace_p4.html">P4</a> program that have an auto-generated control plane API.</p>
<div class="fragment"><div class="line">p4c --target bmv2 --arch v1model --p4runtime-files my-p4-16-prog.p4info.txt my-p4-16-prog.p4</div>
<div class="line">p4c --target bmv2 --arch v1model --p4runtime-files my-p4-14-prog.p4info.txt --std p4-14 my-p4-14-prog.p4</div>
</div><!-- fragment --><p>All of these commands take the <code>--help</code> argument to show documentation of supported command line options. <code>p4c --target-help</code> shows the supported "target, arch" pairs.</p>
<div class="fragment"><div class="line">p4c --help</div>
<div class="line">p4c --target-help</div>
</div><!-- fragment --><p>Auto-translate P4_14 source to P4_16 source:</p>
<div class="fragment"><div class="line">p4test --std p4-14 my-p4-14-prog.p4 --pp auto-translated-p4-16-prog.p4</div>
</div><!-- fragment --><p>Check syntax of P4_16 or P4_14 source code, without limitations that might be imposed by any particular compiler back end. There is no output for these commands other than error and/or warning messages.</p>
<div class="fragment"><div class="line">p4test my-p4-16-prog.p4</div>
<div class="line">p4test --std p4-14 my-p4-14-prog.p4</div>
</div><!-- fragment --><p>Generate GraphViz ".dot" files for parsers and controls of a P4_16 or P4_14 source program.</p>
<div class="fragment"><div class="line">p4c-graphs my-p4-16-prog.p4</div>
<div class="line">p4c-graphs --std p4-14 my-p4-14-prog.p4</div>
</div><!-- fragment --><p>Generate PDF of parser instance named "ParserImpl" generated by the <code>p4c-graphs</code> command above (search for graphviz below for its install instructions):</p>
<div class="fragment"><div class="line">dot -Tpdf ParserImpl.dot &gt; ParserImpl.pdf</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Getting started</h1>
<h2><a class="anchor" id="autotoc_md13"></a>
Installing packaged versions of P4C</h2>
<p>P4C has package support for several Ubuntu and Debian distributions.</p>
<h3><a class="anchor" id="autotoc_md14"></a>
Ubuntu</h3>
<p>A P4C package is available in the following repositories for Ubuntu 20.04 and newer.</p>
<div class="fragment"><div class="line">source /etc/lsb-release</div>
<div class="line">echo &quot;deb http://download.opensuse.org/repositories/home:/p4lang/xUbuntu_${DISTRIB_RELEASE}/ /&quot; | sudo tee /etc/apt/sources.list.d/home:p4lang.list</div>
<div class="line">curl -fsSL https://download.opensuse.org/repositories/home:p4lang/xUbuntu_${DISTRIB_RELEASE}/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/home_p4lang.gpg &gt; /dev/null</div>
<div class="line">sudo apt-get update</div>
<div class="line">sudo apt install p4lang-p4c</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md15"></a>
Debian</h3>
<p>For Debian 11 (Bullseye) it can be installed as follows:</p>
<div class="fragment"><div class="line">echo &#39;deb https://download.opensuse.org/repositories/home:/p4lang/Debian_11/ /&#39; | sudo tee /etc/apt/sources.list.d/home:p4lang.list</div>
<div class="line">curl -fsSL https://download.opensuse.org/repositories/home:p4lang/Debian_11/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/home_p4lang.gpg &gt; /dev/null</div>
<div class="line">sudo apt update</div>
<div class="line">sudo apt install p4lang-p4c</div>
</div><!-- fragment --><p>If you cannot use a repository to install P4C, you can download the <code>.deb</code> file for your release and install it manually. You need to download a new file each time you want to upgrade P4C.</p>
<ol type="1">
<li>Go to <a href="https://build.opensuse.org/package/show/home:p4lang/p4lang-p4c">p4lang-p4c package page on OpenSUSE Build Service</a>, click on "Download package" and choose your operating system version.</li>
<li>Install P4C, changing the path below to the path where you downloaded the package.</li>
</ol>
<div class="fragment"><div class="line">sudo dpkg -i /path/to/package.deb</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
Installing P4C from source</h2>
<ol type="1">
<li>Clone the repository. It includes submodules, so be sure to use <code>--recursive</code> to pull them in: <code> git clone --recursive <a href="https://github.com/p4lang/p4c.git">https://github.com/p4lang/p4c.git</a> </code> If you forgot <code>--recursive</code>, you can update the submodules at any time using: <code> git submodule update --init --recursive </code></li>
<li>Install dependencies. You can find specific instructions for Ubuntu 20.04 here and for macOS 11 here. You can also look at the <a href="tools/ci-build.sh">CI installation script</a>.</li>
<li><p class="startli">Build. Building should also take place in a subdirectory named <code>build</code>. <code> mkdir build cd build cmake .. &lt;optional arguments&gt; make -j4 make -j4 check </code> The cmake command takes the following optional arguments to further customize the build:</p><ul>
<li><code>-DCMAKE_BUILD_TYPE=RELEASE|DEBUG</code> &ndash; set CMAKE_BUILD_TYPE to RELEASE or DEBUG to build with optimizations or with debug symbols to run in gdb. Default is RELEASE.</li>
<li><code>-DCMAKE_INSTALL_PREFIX=&lt;path&gt;</code> &ndash; set the directory where <code>make install</code> installs the compiler. Defaults to /usr/local.</li>
<li><code>-DENABLE_BMV2=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2bmv2_2_r_e_a_d_m_e.html">the bmv2 backend</a>. Default ON.</li>
<li><code>-DENABLE_EBPF=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2ebpf_2_r_e_a_d_m_e.html">the ebpf backend</a>. Default ON.</li>
<li><code>-DENABLE_UBPF=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2ubpf_2_r_e_a_d_m_e.html">the ubpf backend</a>. Default ON.</li>
<li><code>-DENABLE_DPDK=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2dpdk_2_r_e_a_d_m_e.html">the DPDK backend</a>. Default ON.</li>
<li><code>-DENABLE_P4C_GRAPHS=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2graphs_2_r_e_a_d_m_e.html">the p4c-graphs backend</a>. Default ON.</li>
<li><code>-DENABLE_P4TEST=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2p4test_2_r_e_a_d_m_e.html">the p4test backend</a>. Default ON.</li>
<li><code>-DENABLE_TEST_TOOLS=ON|OFF</code>. Enable <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2p4tools_2_r_e_a_d_m_e.html">the p4tools backend</a>. Default OFF.</li>
<li><code>-DENABLE_DOCS=ON|OFF</code>. Build documentation. Default is OFF.</li>
<li><code>-DENABLE_GC=ON|OFF</code>. Enable the use of the garbage collection library. Default is ON.</li>
<li><code>-DENABLE_GTESTS=ON|OFF</code>. Enable building and running GTest unit tests. Default is ON.</li>
<li><code>-DP4C_USE_PREINSTALLED_ABSEIL=ON|OFF</code>. Try to find a system version of Abseil instead of a fetched one. Default is OFF.</li>
<li><code>-DP4C_USE_PREINSTALLED_PROTOBUF=ON|OFF</code>. Try to find a system version of Protobuf instead of a CMake version. Default is OFF.</li>
<li><code>-DENABLE_ABSEIL_STATIC=ON|OFF</code>. Enable the use of static abseil libraries. Default is ON. Only has an effect when <code>P4C_USE_PREINSTALLED_ABSEIL</code> is enabled.</li>
<li><code>-DENABLE_PROTOBUF_STATIC=ON|OFF</code>. Enable the use of static protobuf libraries. Default is ON. Only has an effect when <code>P4C_USE_PREINSTALLED_PROTOBUF</code> is enabled.</li>
<li><code>-DENABLE_MULTITHREAD=ON|OFF</code>. Use multithreading. Default is OFF.</li>
<li><code>-DBUILD_LINK_WITH_GOLD=ON|OFF</code>. Use Gold linker for build if available.</li>
<li><code>-DBUILD_LINK_WITH_LLD=ON|OFF</code>. Use LLD linker for build if available (overrides <code>BUILD_LINK_WITH_GOLD</code>).</li>
<li><code>-DENABLE_LTO=ON|OFF</code>. Use Link Time Optimization (LTO). Default is OFF.</li>
<li><code>-DENABLE_WERROR=ON|OFF</code>. Treat warnings as errors. Default is OFF.</li>
<li><code>-DCMAKE_UNITY_BUILD=ON|OFF</code>. Enable <a href="https://cmake.org/cmake/help/latest/prop_tgt/UNITY_BUILD.html">unity builds</a> for faster compilation. Default is OFF.</li>
</ul>
<p class="startli">If adding new targets to this build system, please see instructions.</p>
</li>
<li>(Optional) Install the compiler and the <a class="el" href="namespace_p4.html">P4</a> shared headers globally. <code> sudo make install </code> The compiler driver <code>p4c</code> and binaries for each of the backends are installed in <code>/usr/local/bin</code> by default; the <a class="el" href="namespace_p4.html">P4</a> headers are placed in <code>/usr/local/share/p4c</code>.</li>
<li>You're ready to go! You should be able to compile a P4-16 program for BMV2 using: <code> p4c -b bmv2-ss-p4org program.p4 -o program.bmv2.json </code></li>
</ol>
<p>If you plan to contribute to P4C, you'll find more useful information here.</p>
<h1><a class="anchor" id="autotoc_md17"></a>
Dependencies</h1>
<p>Ubuntu 20.04 is the officially supported platform for P4C. There's also unofficial support for macOS 11. Other platforms are untested; you can try to use them, but YMMV.</p>
<ul>
<li>A C++17 compiler. GCC 9.1 or later or Clang 6.0 or later is required.</li>
<li><code>git</code> for version control</li>
<li>CMake 3.16.3 or higher</li>
<li>Boehm-Weiser garbage-collector C++ library</li>
<li>GNU Bison and Flex for the parser and lexical analyzer generators.</li>
<li>Google Protocol Buffers v3.25.3 or higher for control plane API generation</li>
<li>C++ boost library</li>
<li>Python 3 for scripting and running tests</li>
<li>Optional: Documentation generation (enabled when configuring with &ndash;enable-doxygen-doc) requires Doxygen (1.8.10 or higher) and Graphviz (2.38.0 or higher).</li>
</ul>
<p>Backends may have additional dependencies. The dependencies for the backends included with <code>P4C</code> are documented here:</p><ul>
<li><a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2bmv2_2_r_e_a_d_m_e.html">BMv2</a></li>
<li><a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2ebpf_2_r_e_a_d_m_e.html">eBPF</a></li>
<li><a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2backends_2graphs_2_r_e_a_d_m_e.html">graphs</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md18"></a>
Ubuntu dependencies</h2>
<p>Most dependencies can be installed using <code>apt-get install</code>:</p>
<div class="fragment"><div class="line">sudo apt-get install cmake g++ git automake libtool libgc-dev bison flex \</div>
<div class="line">libfl-dev libboost-dev libboost-iostreams-dev \</div>
<div class="line">libboost-graph-dev llvm pkg-config python3 python3-pip \</div>
<div class="line">tcpdump</div>
<div class="line"> </div>
<div class="line">pip3 install --user -r requirements.txt</div>
</div><!-- fragment --><p><b>For documentation building:</b></p>
<p><b>Tools</b> </p><div class="fragment"><div class="line">sudo apt-get install -y doxygen graphviz texlive-full</div>
</div><!-- fragment --><p> <b>Theme</b> </p><div class="fragment"><div class="line">git clone --depth 1 -b v2.3.3 https://github.com/jothepro/doxygen-awesome-css ./docs/doxygen/awesome_css</div>
</div><!-- fragment --><p><code>P4C</code> also depends on Google Protocol Buffers (Protobuf). <code>P4C</code> requires version 3.0 or higher, so the packaged version provided in Ubuntu 20.04 <b>should</b> work. However, P4C typically installs its own version of Protobuf using CMake's <code>FetchContent</code> module (at the moment, 3.25.3). If you are experiencing issues with the Protobuf version shipped with your OS distribution, we recommend that to install Protobuf 3.25.3 from source. You can find instructions <a href="https://github.com/protocolbuffers/protobuf/blob/v3.25.3/src/README.md">here</a>. After cloning Protobuf and before you build, check-out version 3.25.3:</p>
<p><code>git checkout v3.25.3</code></p>
<p>Please note that while all Protobuf versions newer than 3.0 should work for P4C itself, you may run into trouble with Abseil, some extensions and other p4lang projects unless you install version 3.25.3.</p>
<p>P4C also depends on Google Abseil library. This library is also a pre-requisite for Protobuf of any version newer than 3.21. Therefore the use of Protobuf of suitable version automatically fulfils Abseil dependency. P4C typically installs its own version of Abseil using CMake's <code>FetchContent</code> module (Abseil LTS 20240116.1 at the moment).</p>
<h3><a class="anchor" id="autotoc_md19"></a>
CMake</h3>
<p>P4C requires a CMake version of at least 3.16.3 or higher. On older systems, a newer version of CMake can be installed using <code>pip3 install --user cmake==3.16.3</code>. We have a CI test on Ubuntu 18.04 that uses this option, but there is no guarantee that this will lead to a successful build.</p>
<h2><a class="anchor" id="autotoc_md20"></a>
Fedora dependencies</h2>
<div class="fragment"><div class="line">sudo dnf install -y cmake g++ git automake libtool gc-devel bison flex \</div>
<div class="line">libfl-devel gmp-devel boost-devel boost-iostreams boost-graph llvm pkg-config \</div>
<div class="line">python3 python3-pip tcpdump</div>
<div class="line"> </div>
<div class="line">sudo pip3 install -r requirements.txt</div>
</div><!-- fragment --><p><b>For documentation building:</b></p>
<p><b>Tools</b> </p><div class="fragment"><div class="line">sudo dnf install -y doxygen graphviz texlive-scheme-full</div>
</div><!-- fragment --><p> <b>Theme</b> </p><div class="fragment"><div class="line">git clone --depth 1 -b v2.3.3 https://github.com/jothepro/doxygen-awesome-css ./docs/doxygen/awesome_css</div>
</div><!-- fragment --><p>You can also look at the <a href="tools/install_fedora_deps.sh">dependencies installation script</a> for a fresh Fedora instance.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
macOS dependencies</h2>
<p>Installing on macOS:</p>
<ul>
<li>Enable XCode's command-line tools: <div class="fragment"><div class="line">xcode-select --install</div>
</div><!-- fragment --></li>
<li>Install Homebrew: <div class="fragment"><div class="line">/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</div>
</div><!-- fragment --> Be sure to add <code>/usr/local/bin/</code> to your <code>$PATH</code>.</li>
<li><p class="startli">Install dependencies using Homebrew: </p><div class="fragment"><div class="line">brew install autoconf automake libtool bdw-gc boost bison pkg-config</div>
</div><!-- fragment --><p> or with MacPorts </p><div class="fragment"><div class="line">sudo port install autoconf automake coreutils libtool boehmgc boost bison pkg-config</div>
</div><!-- fragment --><p class="startli">By default, Homebrew doesn't link programs into <code>/usr/local/bin</code> if they would conflict with a version provided by the base system. This includes Bison, since an older version ships with macOS. <code>make check</code> depends on the newer Bison we just installed from Homebrew (see <a href="http://github.com/p4lang/p4c/issues/83">#83</a>), so you'll want to add it to your <code>$PATH</code> one way or another. One simple way to do that is to request that Homebrew link it into <code>/usr/local/bin</code>: </p><div class="fragment"><div class="line">brew link --force bison</div>
</div><!-- fragment --><p class="startli">Optional documentation building tools: </p><div class="fragment"><div class="line">brew install doxygen graphviz</div>
</div><!-- fragment --><p> Optional Documentation theme: </p><div class="fragment"><div class="line">git clone --depth 1 -b v2.3.3 https://github.com/jothepro/doxygen-awesome-css ./docs/doxygen/awesome_css</div>
</div><!-- fragment --><p class="startli">Homebrew offers a <code>protobuf</code> formula. It installs version 3.2, which should work for P4C itself but may cause problems with some extensions. It's preferable to use the version of Protobuf which is supplied with CMake's fetchcontent (3.25.3).</p>
<p class="startli">The <code>protobuf</code> formula requires the following CMake variables to be set, otherwise CMake does not find the libraries or fails in linking. It is likely that manually installed Protobuf will require similar treatment.</p>
<div class="fragment"><div class="line">PB_PREFIX=&quot;$(brew --prefix --installed protobuf)&quot;</div>
<div class="line">./bootstrap.sh \</div>
<div class="line">  -DProtobuf_INCLUDE_DIR=&quot;${PB_PREFIX}/include/&quot; \</div>
<div class="line">  -DProtobuf_LIBRARY=&quot;${PB_PREFIX}/lib/libprotobuf.dylib&quot; \</div>
<div class="line">  -DENABLE_PROTOBUF_STATIC=OFF</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md22"></a>
Garbage collector</h2>
<p>P4c relies on <a href="https://github.com/ivmai/bdwgc">BDW garbage collector</a> to manage its memory. By default, the P4C executables are linked with the garbage collector library. When the GC causes problems, this can be disabled by setting <code>ENABLE_GC</code> cmake option to <code>OFF</code>. However, this will dramatically increase the memory usage by the compiler, and may become impractical for compiling large programs. <b>Do not disable the GC</b>, unless you really have to. We have noticed that this may be a problem on MacOS.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Crash dumps</h2>
<p>P4c will use <a href="https://github.com/ianlancetaylor/libbacktrace.git">libbacktrace</a> to produce readable crash dumps if it is available. This is an optional dependency; if it is not available everything should build just fine, but crash dumps will not be very readable.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Development tools</h1>
<p>There is a variety of design and development documentation <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2docs_2_r_e_a_d_m_e.html">here</a>.</p>
<p>We recommend using <code>clang++</code> with no optimizations for speeding up compilation and simplifying debugging.</p>
<p>We recommend installing a new version of <a href="http://ftp.gnu.org/gnu/gdb">gdb</a>, because older gdb versions do not always handle C++11 or newer correctly.</p>
<p>We recommend exuberant ctags for navigating source code in Emacs and vi. <code>sudo apt-get install exuberant-ctags.</code> The Makefile targets <code>make ctags</code> and <code>make etags</code> generate tags for vi and Emacs respectively. (Make sure that you are using the correct version of ctags; there are several competing programs with the same name in existence.)</p>
<p>To enable building code documentation, please run <code>cmake .. -DENABLE_DOCS=ON</code>. This enables the <code>make docs</code> rule to generate documentation. The HTML output is available in <code>build/doxygen-out/html/index.html</code>.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Git setup</h2>
<p>Occasionally formatting commits are applied to P4C. These pollute the git history. To ignore these commits in git blame, run this command </p><div class="fragment"><div class="line">config blame.ignoreRevsFile .git-blame-ignore-revs</div>
</div><!-- fragment --><p>The P4C code base is subject to a series of linter checks which are checked by CI. To avoid failing these checks and wasting unnecessary CI cycles and resources, you can install <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">git commit hooks</a> by running </p><div class="fragment"><div class="line">/tools/install_git_hooks.sh</div>
</div><!-- fragment --><p> These commit hooks will run on every commit and check the files you are planning to commit with cpplint and clang-format.</p>
<h1><a class="anchor" id="autotoc_md26"></a>
Docker</h1>
<p>A Dockerfile is included. You can generate an image which contains a copy of P4C in <code>/p4c/build</code> by running:</p>
<div class="fragment"><div class="line">docker build -t p4c .</div>
</div><!-- fragment --><p>On some platforms Docker limits the memory usage of any container, even containers used during the <code>docker build</code> process. On macOS in particular the default is 2GB, which is not enough to build P4C. Increase the memory limit to at least 4GB via Docker preferences or you are likely to see "internal compiler
errors" from GCC which are caused by low memory.</p>
<h1><a class="anchor" id="autotoc_md27"></a>
Bazel</h1>
<p><a href="https://github.com/p4lang/p4c/actions/workflows/ci-bazel.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-bazel.yml/badge.svg" alt="Bazel Build" style="pointer-events: none;" class="inline"/></a></p>
<p>The project can also be build using <a href="https://bazel.build">Bazel</a>: </p><div class="fragment"><div class="line">bazel build //...</div>
</div><!-- fragment --><p> We run continuous integration to ensure this works with the latest version of Bazel.</p>
<p>We also provide a <a href="bazel/p4_library.bzl"><code>p4_library</code> rule</a> for invoking P4C during the build process of 3rd party Bazel projects.</p>
<p>See <a href="bazel/example">bazel/example</a> for an example of how to use or extend P4C in your own Bazel project. You may use it as a template to get you started.</p>
<h1><a class="anchor" id="autotoc_md28"></a>
Build system</h1>
<p>The build system is based on cmake. This section describes how it can be customized.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Defining new CMake targets</h2>
<p>When building a new backend target, add it into the development tree in the extensions subdirectory. The cmake-based build system will automatically include it if it contains a CMakeLists.txt file.</p>
<p>For a new backend, the cmake file should contain the following rules:</p>
<h3><a class="anchor" id="autotoc_md30"></a>
IR definition files</h3>
<p>Backend specific IR definition files should be added to the global list of IR_DEF_FILES as they are processed together with the core IR files. Use the following rule:</p>
<div class="fragment"><div class="line">set (IR_DEF_FILES ${IR_DEF_FILES} ${MY_IR_DEF_FILES} PARENT_SCOPE)</div>
</div><!-- fragment --><p> where <code>MY_IR_DEF_FILES</code> is a list of file names with absolute path (for example, use <code>${CMAKE_CURRENT_SOURCE_DIR}</code>).</p>
<p>If in addition you have additional supporting source files, they should be added to the ir sources, as follows:</p>
<div class="fragment"><div class="line">set(EXTENSION_IR_SOURCES ${EXTENSION_IR_SOURCES} ${MY_IR_SRCS} PARENT_SCOPE)</div>
</div><!-- fragment --><p> Again, <code>MY_IR_SRCS</code> is a list of file names with absolute path.</p>
<h3><a class="anchor" id="autotoc_md31"></a>
Source files</h3>
<p>Sources (.cpp and .h) should be added to the cpplint and clang-format target using the following rule:</p>
<div class="fragment"><div class="line">add_cpplint_files (${CMAKE_CURRENT_SOURCE_DIR} &quot;${MY_SOURCES_AND_HEADERS}&quot;)</div>
<div class="line">add_clang_format_files (${CMAKE_CURRENT_SOURCE_DIR} &quot;${MY_SOURCES_AND_HEADERS}&quot;)</div>
</div><!-- fragment --><p>Python files should be added to the black and isort target using the following rule: </p><div class="fragment"><div class="line">add_black_files (${CMAKE_CURRENT_SOURCE_DIR} &quot;${MY_SOURCES_AND_HEADERS}&quot;)</div>
</div><!-- fragment --><p>The P4C CMakeLists.txt will use that name to figure the full path of the files to lint.</p>
<p>clang-format, black, and isort need to be installed before the linter can be used. They can be installed with the following command: </p><div class="fragment"><div class="line">pip3 install --user &quot;clang-format==18.1.0&quot; &quot;black==24.3.0&quot; &quot;isort==5.13.2&quot;</div>
</div><!-- fragment --><p> clang-format can be checked using the <code>make clang-format</code> command. Complaints can be fixed by running <code>make clang-format-fix-errors</code>. black and isort can be checked using the <code>make black</code> or <code>make isort</code> command respectively. Complaints can be fixed by running <code>make black-fix-errors</code> or <code>make isort-fix-errors</code>.</p>
<p>cpplint, clang-format, and black/isort run as checks as port of P4C's continuous integration process. To make sure that these tests pass, we recommend installing the appropriate git hooks. This can be done by running </p><div class="fragment"><div class="line">./tools/install_git_hooks.sh</div>
</div><!-- fragment --><p> clang-format, cpplint, and black/isort checks will be enforced on every branch commit. In cases where checks are failing but the commit is sound, one can bypass the hook enforcement using <code>git commit --no-verify</code>.</p>
<h3><a class="anchor" id="autotoc_md32"></a>
Target</h3>
<p>Define a target for your executable. The target should link against the core <code>P4C_LIBRARIES</code> and <code>P4C_LIB_DEPS</code>. <code>P4C_LIB_DEPS</code> are package dependencies. If you need additional libraries for your project, add them to <code>P4C_LIB_DEPS</code>.</p>
<p>In addition, your target should depend on the <code>genIR</code> target, since you need all the IR generation to happen before you start compiling your backend. If you chose to have your backend as a library (seem the backends/bmv2 example), the library should depend on <code>genIR</code>, and there is no longer necessary for your executable to depend on it.</p>
<div class="fragment"><div class="line">add_executable(p4c-mybackend ${MY_SOURCES})</div>
<div class="line">target_link_libraries (p4c-mybackend ${P4C_LIBRARIES} ${P4C_LIB_DEPS})</div>
<div class="line">add_dependencies(p4c-mybackend genIR)</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md33"></a>
Tests</h3>
<p>We implemented support equivalent to the automake <code>make check</code> rules. All tests should be included in <code>make check</code> and in addition, we support <code>make check-*</code> rules. To enable this support, add the following rules:</p>
<div class="fragment"><div class="line">set(MY_DRIVER &lt;driver or compiler executable&gt;)</div>
<div class="line"> </div>
<div class="line">set (MY_TEST_SUITES</div>
<div class="line">  ${P4C_SOURCE_DIR}/testdata/p4_16_samples/*.p4</div>
<div class="line">  ${P4C_SOURCE_DIR}/testdata/p4_16_errors/*.p4</div>
<div class="line">  )</div>
<div class="line">set (MY_XFAIL_TESTS</div>
<div class="line">  testdata/p4_16_errors/this_test_fails.p4</div>
<div class="line"> )</div>
<div class="line">p4c_add_tests(&quot;mybackend&quot; ${MY_DRIVER} &quot;${MY_TEST_SUITES}&quot; &quot;${MY_XFAIL_TESTS}&quot;)</div>
</div><!-- fragment --><p>In addition, you can add individual tests to a suite using the following macro: </p><div class="fragment"><div class="line">set(isXFail FALSE)</div>
<div class="line">set(SWITCH_P4 testdata/p4_14_samples/switch_20160512/switch.p4)</div>
<div class="line"> </div>
<div class="line">p4c_add_test_with_args (&quot;mybackend&quot; ${MY_DRIVER} ${isXFail}</div>
<div class="line">  &quot;switch_with_custom_profile&quot; ${SWITCH_P4} &quot;-DCUSTOM_PROFILE&quot;)</div>
</div><!-- fragment --><p>See the documentation for <a href="cmake/P4CUtils.cmake"><code>p4c_add_test_with_args</code></a> and <a href="cmake/P4CUtils.cmake"><code>p4c_add_tests</code></a> for more information on the arguments to these macros.</p>
<p>To pass custom arguments to P4C, you can set the environment variable <code>P4C_ARGS</code>: </p><div class="fragment"><div class="line">make check P4C_ARGS=&quot;-Xp4c=MY_CUSTOM_FLAG&quot;</div>
</div><!-- fragment --><p>When making changes to P4C, it is sometimes useful to be able to run the tests while overwriting the expected output files that are saved in this repository. One such situation is when your changes to P4C cause the names of compiler-generated local variables to change. To force the expected output files to be rewritten while running the tests, assign a value to the shell environment variable <code>P4TEST_REPLACE</code>. Here is one example Bash command to do so:</p>
<div class="fragment"><div class="line">P4TEST_REPLACE=1 make check</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md34"></a>
Installation</h3>
<p>Define rules to install your backend. Typically you need to install the binary, the additional architecture headers, and the configuration file for the P4C driver.</p>
<div class="fragment"><div class="line">install (TARGETS p4c-mybackend</div>
<div class="line">  RUNTIME DESTINATION ${P4C_RUNTIME_OUTPUT_DIRECTORY})</div>
<div class="line">install (DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/p4include</div>
<div class="line">  DESTINATION ${P4C_ARTIFACTS_OUTPUT_DIRECTORY})</div>
<div class="line">install (FILES ${CMAKE_CURRENT_SOURCE_DIR}/driver/p4c.mybackend.cfg</div>
<div class="line">  DESTINATION ${P4C_ARTIFACTS_OUTPUT_DIRECTORY}/p4c_src)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md35"></a>
Known issues</h1>
<p>Issues with the compiler are tracked on <a href="https://github.com/p4lang/p4c/issues">GitHub</a>. Before opening a new issue, please check whether a similar issue is already opened. Opening issues and submitting a pull request with fixes for those issues is much appreciated.</p>
<p>In addition to the list of issues on Github, there are a number of currently unsupported features listed below:</p>
<h2><a class="anchor" id="autotoc_md36"></a>
Frontend</h2>
<h3><a class="anchor" id="autotoc_md37"></a>
P4_14 features not supported in P4_16</h3>
<ul>
<li>extern/blackbox attributes &ndash; there is support for carrying them in the IR, but they are lost if P4_16 code is output. Backends can access them from the IR</li>
<li>Nonstandard extension primitives from P4_14<ul>
<li>Execute_meter extra arguments</li>
<li>Recirculate/clone/resubmit variants</li>
<li>Bypass_egress</li>
<li>Sample_ primitives</li>
<li>invalidate</li>
</ul>
</li>
<li>No support for P4_14 parser exceptions.</li>
</ul>
<h2><a class="anchor" id="autotoc_md38"></a>
Backends</h2>
<h3><a class="anchor" id="autotoc_md39"></a>
Bmv2 Backend</h3>
<ul>
<li>Tables with multiple apply calls</li>
</ul>
<p>See also <a href="backends/bmv2/README.md#unsupported-p4_16-language-features">unsupported P4_16 language features</a>.</p>
<h1><a class="anchor" id="autotoc_md40"></a>
How to Contribute</h1>
<p>We welcome and appreciate new contributions. Please take a moment to review our <a class="el" href="md__2home_2runner_2work_2p4c_2p4c_2_c_o_n_t_r_i_b_u_t_i_n_g.html">Contribution Guidelines</a> to get started.</p>
<h1><a class="anchor" id="autotoc_md41"></a>
P4 Compiler Onboarding</h1>
<p>Educational material on <a class="el" href="namespace_p4.html">P4</a>:</p>
<ul>
<li>General hands-on <a href="https://github.com/p4lang/tutorials">tutorials</a>.</li>
<li><a href="https://github.com/jafingerhut/p4-guide?tab=readme-ov-file#introduction">Technical documentation on P4-related topics</a>.</li>
<li>Motivating <a class="el" href="namespace_p4.html">P4</a>: <a href="https://www.youtube.com/watch?v=8ie0FcsN07U">IEEE ICC 2018 // Keynote: Nick McKeown, Programmable Forwarding Planes Are Here To Stay</a></li>
<li>Introducing P4-16 in detail:<ul>
<li>Part 1: <a href="https://www.youtube.com/watch?v=GslseT4hY1w">Introduction to P4_16. Part 1</a></li>
<li>Part 2: <a href="https://www.youtube.com/watch?v=yqxpypXIOtQ">Introduction to P4_16. Part 2</a></li>
</ul>
</li>
<li>Material on the official <a class="el" href="namespace_p4.html">P4</a> compiler:<ul>
<li><a href="https://www.youtube.com/watch?v=Rx5AQ0IF6eU">Understanding the Open-Source P4-16 Compiler - February 15, 2022 - Mihai Budiu</a></li>
<li><a href="https://www.youtube.com/watch?v=YnPHPaPSmpU">Understanding P4-16 Open-Source Compiler, Part 2 - March 1, 2022 - Mihai Budiu</a></li>
<li><a href="https://github.com/p4lang/p4c/blob/main/docs/compiler-design.pdf">Compiler Design - Implementation Architecture</a>.</li>
</ul>
</li>
<li>Introduction to P4Runtime: <a href="https://www.youtube.com/watch?v=KRx92qSLgo4">Next-Gen SDN Tutorial - Session 1: P4 and P4Runtime Basics</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md42"></a>
Contact</h1>
<p>We appreciate your contributions and look forward to working with you to improve the <a class="el" href="namespace_p4.html">P4</a> Compiler Project (P4C)!</p><ul>
<li>For further assistance or questions regarding contributions, reach out to us in our <a href="https://p4lang.zulipchat.com/">community chat</a>. <a href="https://p4lang.zulipchat.com/join/kjtv2reafrylssget425wx6c/">Joining link</a> .</li>
<li>For general P4-related questions, use the <a href="https://forum.p4.org/">P4 forum</a>.</li>
<li>For other communication channels click <a href="https://p4.org/join/">here</a>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.11.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
